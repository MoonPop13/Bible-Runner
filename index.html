<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bible Runner â€“ Ancient Jerusalem</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <!-- Brony Siswad font (place in ./fonts/BronySiswad.ttf) -->
  <style>
    @font-face {
      font-family: 'Brony Siswad';
      src: url('./fonts/BronySiswad.ttf') format('truetype');
      font-display: swap;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: linear-gradient(to bottom, #87b8e0  0%, #e2c28b 100%);
      color: #4a3e23;
      font-family: 'Brony Siswad', Arial, sans-serif;
      user-select: none;
      -webkit-user-select: none;
      overscroll-behavior: none;
      touch-action: manipulation;
    }
    body {
      min-height: 100vh;
      min-width: 100vw;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      overflow-x: hidden;
    }
    #app-root {
      width: 100vw;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    /* Main Menu */
    .menu-container {
      width: 100vw;
      max-width: 520px;
      padding: 22px 10px 34px 10px;
      box-sizing: border-box;
      margin-top: 32px;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: #fff8e1;
      border-radius: 22px;
      border: 2.5px solid #cbb994;
      box-shadow: 0 3px 24px #b8a07833;
    }
    .game-title {
      font-size: 2.4em;
      letter-spacing: 2.5px;
      margin-bottom: 12px;
      font-family: 'Brony Siswad', Arial, sans-serif;
      color: #8a6c36;
      text-align: center;
      text-shadow: 2px 2px 0 #faefd0;
    }
    .theme-bar {
      width: 80%;
      height: 19px;
      background: repeating-linear-gradient(135deg, #ccb684, #e2c28b 10px, #ccb684 20px);
      border-radius: 9px;
      margin: 0 auto 14px auto;
      box-shadow: 0 1px 4px #b8a07833;
    }
    .instructions {
      font-size: 1.08em;
      max-width: 450px;
      margin-bottom: 18px;
      color: #5a4c2f;
      background: #fff3d4;
      border-radius: 10px;
      padding: 12px 16px;
      border: 1.5px solid #e2c28b;
      box-shadow: 0 0 2px #cbb994;
    }
    .level-list {
      list-style: none;
      padding: 0;
      width: 100%;
      max-width: 430px;
      margin: 0 0 24px 0;
    }
    .level-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #e3d2ae;
      margin-bottom: 10px;
      padding: 14px 18px;
      border-radius: 13px;
      font-size: 1.12em;
      cursor: pointer;
      border: 2px solid #cbb994;
      transition: box-shadow 0.15s, background 0.13s;
      box-shadow: 0 1px 2px #e2c28b;
      user-select: none;
    }
    .level-item:hover, .level-item.selected {
      background: #f5e2ba;
      box-shadow: 0 2px 6px #e2c28b;
      border-color: #a89564;
    }
    .level-score {
      display: flex;
      align-items: center;
      gap: 2px;
      margin-left: 12px;
    }
    .level-score img {
      width: 22px; height: 22px; object-fit: contain;
      filter: drop-shadow(0 1px 1px #fff8e1);
    }
    .level-score .heart-outline {
      filter: grayscale(1) brightness(1.5) contrast(0.7);
    }
    /* Game Screen */
    .game-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100vw;
      max-width: 520px;
      background: #faefd0;
      border-radius: 0 0 18px 18px;
      padding: 9px 18px 8px 18px;
      margin-bottom: 0;
      min-height: 46px;
      box-sizing: border-box;
      font-size: 1em;
      position: relative;
      z-index: 2;
      border-bottom: 2px solid #cbb994;
    }
    .game-header .header-title {
      font-weight: bold;
      font-size: 1.13em;
      letter-spacing: 1px;
      color: #8a6c36;
      font-family: 'Brony Siswad', Arial, sans-serif;
    }
    .header-lives, .header-breads {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .header-lives img, .header-breads img {
      width: 22px; height: 22px;
      object-fit: contain;
    }
    /* Subtitles */
    .subtitle-bar {
      width: 100vw;
      max-width: 520px;
      min-height: 40px;
      overflow: hidden;
      background: #f5e2ba;
      border-bottom: 2px solid #cbb994;
      border-top: 2px solid #cbb994;
      margin-bottom: 0;
      position: relative;
      z-index: 1;
      display: flex;
      align-items: center;
      font-size: 1.09em;
      color: #7d6a39;
      font-family: Arial, sans-serif;
    }
    .subtitle-scroll {
      position: absolute;
      white-space: nowrap;
      will-change: transform;
      left: 0;
      top: 0; bottom: 0;
      padding: 0 10px;
      font-weight: 500;
      transition: color 0.2s;
      pointer-events: none;
      text-overflow: ellipsis;
    }
    /* Game Canvas Area */
    .game-canvas-area {
      width: 100vw;
      max-width: 520px;
      aspect-ratio: 1.8/1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 14px;
      overflow: hidden;
      background: #e2c28b;
      margin-top: 0;
      position: relative;
      box-shadow: 0 3px 13px #cbb99467;
      border: 2.5px solid #cbb994;
    }
    canvas#game-canvas {
      width: 100vw;
      max-width: 520px;
      height: auto;
      display: block;
      background: transparent;
      outline: none;
      touch-action: none;
    }
    /* Jump Button */
    .jump-btn-container {
      width: 100vw;
      max-width: 520px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 18px 0 0 0;
    }
    .jump-btn {
      font-size: 1.26em;
      font-family: 'Brony Siswad', Arial, sans-serif;
      padding: 14px 38px;
      border: none;
      border-radius: 19px;
      background: linear-gradient(90deg, #e2c28b 0%, #b8a078 100%);
      color: #635934;
      font-weight: bold;
      letter-spacing: 1px;
      cursor: pointer;
      box-shadow: 0 2px 8px #e2c28b;
      transition: background 0.19s, box-shadow 0.18s;
    }
    .jump-btn:active {
      background: #ccb684;
      box-shadow: 0 1.5px 6px #b8a078;
    }
    /* Fullscreen Button */
    .fullscreen-btn {
      position: absolute;
      right: 12px;
      top: 8px;
      width: 34px; height: 34px;
      background: rgba(250,240,210,0.82);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      z-index: 9;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 4px #e2c28b;
      transition: background 0.16s;
    }
    .fullscreen-btn:active {
      background: #f5e2ba;
    }
    .fullscreen-btn svg {
      width: 22px; height: 22px;
      fill: #b8a078;
    }
    /* End/Fail Popup */
    .popup-bg {
      position: fixed;
      z-index: 50;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(142,112,60,0.21);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .popup {
      background: #fff8e1;
      border-radius: 22px;
      border: 2.5px solid #cbb994;
      box-shadow: 0 2px 32px #b8a07833;
      padding: 30px 16px 18px 16px;
      min-width: 260px;
      max-width: 94vw;
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 1.09em;
      animation: popin 0.34s cubic-bezier(.4,1.4,.3,1) backwards;
    }
    @keyframes popin {
      0% { transform: scale(0.6) translateY(80px); opacity:0;}
      80% { transform: scale(1.08) translateY(-13px); opacity:1;}
      100% { transform: scale(1) translateY(0px); opacity:1;}
    }
    .popup h2 {
      font-family: 'Brony Siswad', Arial, sans-serif;
      margin: 0 0 15px 0;
      font-size: 1.37em;
      color: #b8a078;
      text-align: center;
    }
    .popup .popup-score {
      display: flex; align-items: center; gap: 8px; margin: 12px 0 10px 0;
    }
    .popup .popup-score img {
      width: 26px; height: 26px;
    }
    .popup .popup-btns {
      margin-top: 15px;
      display: flex;
      gap: 17px;
    }
    .popup .popup-btns button {
      font-family: 'Brony Siswad', Arial, sans-serif;
      font-size: 1.07em;
      padding: 9px 22px;
      border: none;
      border-radius: 19px;
      background: #faefd0;
      color: #8a6c36;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 1px 4px #e2c28b;
      transition: background 0.14s;
    }
    .popup .popup-btns button:active { background: #f5e2ba; }
    @media (max-width: 650px) {
      .menu-container, .game-header, .subtitle-bar, .game-canvas-area, .jump-btn-container {
        max-width: 100vw!important;
        border-radius: 0;
      }
      .popup { max-width: 97vw; }
    }
    @media (max-width: 480px) {
      .game-title { font-size: 1.19em; }
      .instructions { font-size: 0.98em; }
      .level-item { font-size: 0.97em; padding: 10px 8px; }
      .popup { font-size: 0.97em; padding: 10px 3vw 12px 3vw; }
      .jump-btn { padding: 11px 10vw; font-size: 1.03em;}
      .subtitle-bar { font-size: 0.97em;}
    }
  </style>
</head>
<body>
  <div id="app-root"></div>
  <!-- JS and asset integration below -->
  <script>
  // --- ASSET PATHS (update these to your ancient-themed images!) ---
  const ASSETS = {
    images: {
      heart: './img/heart.png',               // e.g. white carved stone heart
      heartOutline: './img/heart-outline.png',// e.g. faint stone heart outline
      bread: './img/manna-bread.png',         // ancient loaf/manna
      bg: './img/jerusalem-bg.png',           // panoramic Jerusalem/temple hills
      charIdle: './img/char-idle-biblical.png', // tunic/sash/sandals
      charJump: './img/char-jump-biblical.png',
      obstacle: './img/clay-jar.png'           // or sheep, baskets, etc.
    },
    font: './fonts/BronySiswad.ttf',
    music: './audio/bg-music-jerusalem.mp3',   // ancient lyre/oud (instrumental)
    // Per-level assets (replace with your own mp3/vtt files)
    levels: [
      { name: "Genesis 1:26â€“31", audio: "./audio/gen1_26-31.mp3", vtt: "./subs/gen1_26-31.vtt" },
      { name: "Genesis 3:1â€“13", audio: "./audio/gen3_1-13.mp3", vtt: "./subs/gen3_1-13.vtt" },
      { name: "Genesis 6:5â€“9, 7:17â€“8:1", audio: "./audio/gen6_5-9_7_17-8_1.mp3", vtt: "./subs/gen6_5-9_7_17-8_1.vtt" },
      { name: "Genesis 12:1â€“9", audio: "./audio/gen12_1-9.mp3", vtt: "./subs/gen12_1-9.vtt" },
      { name: "Genesis 22:1â€“14", audio: "./audio/gen22_1-14.mp3", vtt: "./subs/gen22_1-14.vtt" },
      { name: "Genesis 37:1â€“11", audio: "./audio/gen37_1-11.mp3", vtt: "./subs/gen37_1-11.vtt" },
      { name: "Genesis 45:1â€“15", audio: "./audio/gen45_1-15.mp3", vtt: "./subs/gen45_1-15.vtt" }
    ]
  };

  // --- LOCAL STORAGE KEYS ---
  const STORAGE_BREAD = "bible-run-bread";
  const STORAGE_PLAYED = "bible-run-played";

  // --- GLOBAL STATE ---
  let gameState = {
    screen: "menu", // "menu", "game", "end"
    selectedLevel: null,
    breadScores: [],
    playedLevels: [],
    music: null,
    musicVolume: 0.5,
    levelAudio: null,
    subtitles: [],
    subtitleIndex: 0,
    subtitleCurrent: "",
    subtitleStart: 0,
    subtitleEnd: 0,
    subtitleScrollX: 0,
    subtitleBarWidth: 0,
    subtitleActive: false,
    running: false,
    jumpPressed: false,
    jumpY: 0,
    jumpV: 0,
    jumpStart: false,
    playerY: 0,
    playerState: "idle", // "idle" or "jump"
    obstacleList: [],
    breadList: [],
    collectedBreads: 0,
    lives: 3,
    bgImage: null,
    charIdle: null,
    charJump: null,
    breadImg: null,
    heartImg: null,
    heartOutlineImg: null,
    obstacleImg: null,
    bgMusic: null,
    canvas: null,
    ctx: null,
    animFrame: null,
    gameStartTime: 0,
    levelDuration: 0,
    audioStartedAt: 0,
    levelEnded: false,
    endType: null // "win" or "fail"
  };

  // --- PRELOAD IMAGES ---
  function preloadImages(callback) {
    let imgs = {};
    let loaded = 0;
    let keys = Object.keys(ASSETS.images);
    for (let k of keys) {
      imgs[k] = new window.Image();
      imgs[k].src = ASSETS.images[k];
      imgs[k].onload = () => { loaded++; if (loaded === keys.length) callback(imgs); };
      imgs[k].onerror = () => { loaded++; if (loaded === keys.length) callback(imgs); };
    }
  }

  // --- LOAD SCORES FROM STORAGE ---
  function loadScores() {
    let arr = [], arr2 = [];
    try {
      let s = localStorage.getItem(STORAGE_BREAD);
      let p = localStorage.getItem(STORAGE_PLAYED);
      arr = s ? JSON.parse(s) : [];
      arr2 = p ? JSON.parse(p) : [];
      if (!Array.isArray(arr)) arr = [];
      if (!Array.isArray(arr2)) arr2 = [];
    } catch(e) { arr = []; arr2 = []; }
    while(arr.length < ASSETS.levels.length) arr.push(0);
    while(arr2.length < ASSETS.levels.length) arr2.push(false);
    return [arr, arr2];
  }
  function saveScores() {
    localStorage.setItem(STORAGE_BREAD, JSON.stringify(gameState.breadScores));
    localStorage.setItem(STORAGE_PLAYED, JSON.stringify(gameState.playedLevels));
  }

  // --- MAIN RENDER LOOP ---
  function render() {
    let root = document.getElementById('app-root');
    root.innerHTML = '';
    if (gameState.screen === "menu") renderMenu(root);
    else if (gameState.screen === "game") renderGameUI(root);
    else if (gameState.screen === "end") renderEndPopup(root);
  }

  // --- MAIN MENU ---
  function renderMenu(root) {
    document.body.style.background = "linear-gradient(to bottom, #87b8e0 0%, #e2c28b 100%)";
    stopMusic();
    let container = document.createElement('div');
    container.className = 'menu-container';
    let themeBar = document.createElement('div');
    themeBar.className = 'theme-bar';
    container.appendChild(themeBar);
    let title = document.createElement('div');
    title.className = 'game-title';
    title.innerText = "Bible Runner: Ancient Jerusalem";
    container.appendChild(title);
    let ins = document.createElement('div');
    ins.className = 'instructions';
    ins.innerHTML = `
    <b>How to Play:</b>
    <ul style="margin: 0.2em 0 0.2em 1.2em; padding-left:0.5em;">
    <li>Choose any passage to run through ancient Jerusalem!</li>
    <li>Tap <b>Jump</b> or press the <b>space bar</b> to leap over clay jars, baskets, or sheep and collect <b>manna bread</b> awards.</li>
    <li>Listen as the Bible passage is read and watch the verse scroll at the top.</li>
    <li>3 lives per level. Losing all means you must try again.</li>
    <li>Collect up to <b>3 breads</b>. Your best score is remembered for each passage.</li>
    </ul>
    `;
    container.appendChild(ins);
    let ul = document.createElement('ul');
    ul.className = 'level-list';
    for (let i = 0; i < ASSETS.levels.length; ++i) {
      let li = document.createElement('li');
      li.className = 'level-item';
      li.tabIndex = 0;
      li.innerHTML = `<span>${ASSETS.levels[i].name}</span>`;
      let sc = document.createElement('span');
      sc.className = 'level-score';
      if (gameState.playedLevels[i]) {
        for (let k = 0; k < 3; ++k) {
          let img = document.createElement('img');
          img.src = k < gameState.breadScores[i]
            ? gameState.breadImg.src
            : gameState.heartOutlineImg.src;
          img.alt = k < gameState.breadScores[i] ? "Bread" : "Heart";
          img.className = k < gameState.breadScores[i] ? "" : "heart-outline";
          sc.appendChild(img);
        }
      } else {
        for (let k = 0; k < 3; ++k) {
          let img = document.createElement('img');
          img.src = gameState.heartOutlineImg.src;
          img.alt = "Heart";
          img.className = "heart-outline";
          sc.appendChild(img);
        }
      }
      li.appendChild(sc);
      li.onclick = () => {
        gameState.selectedLevel = i;
        renderLevelStartPopup();
      };
      li.onkeyup = (e) => { if (e.key === 'Enter' || e.key === ' ') li.onclick(); };
      ul.appendChild(li);
    }
    container.appendChild(ul);
    root.appendChild(container);
  }

  // --- LEVEL START POPUP ---
  function renderLevelStartPopup() {
    let root = document.getElementById('app-root');
    let overlay = document.createElement('div');
    overlay.className = 'popup-bg';
    let pop = document.createElement('div');
    pop.className = 'popup';
    pop.innerHTML = `
      <h2>${ASSETS.levels[gameState.selectedLevel].name}</h2>
      <div style="margin: 4px 0 16px 0; color:#7d6a39; font-size:1em;">
        Collect as much ancient bread as you can.<br>
        Avoid obstacles. 3 lives per run!
      </div>
    `;
    let btns = document.createElement('div');
    btns.className = 'popup-btns';
    let btnStart = document.createElement('button');
    btnStart.innerText = "Start Game";
    btnStart.onclick = () => {
      document.body.requestFullscreen && document.body.requestFullscreen();
      startGame();
    };
    let btnMenu = document.createElement('button');
    btnMenu.innerText = "Main Menu";
    btnMenu.onclick = () => {
      gameState.screen = "menu";
      render();
    };
    btns.appendChild(btnStart);
    btns.appendChild(btnMenu);
    pop.appendChild(btns);
    overlay.appendChild(pop);
    root.appendChild(overlay);
  }

  // --- GAME UI ---
  function renderGameUI(root) {
    document.body.style.background = "linear-gradient(to bottom, #87b8e0 0%, #e2c28b 100%)";
    let header = document.createElement('div');
    header.className = 'game-header';
    let lives = document.createElement('div');
    lives.className = 'header-lives';
    for (let i = 0; i < 3; ++i) {
      let img = document.createElement('img');
      img.src = i < gameState.lives ? gameState.heartImg.src : gameState.heartOutlineImg.src;
      img.alt = "Heart";
      lives.appendChild(img);
    }
    header.appendChild(lives);
    let title = document.createElement('span');
    title.className = 'header-title';
    title.innerText = ASSETS.levels[gameState.selectedLevel].name;
    header.appendChild(title);
    let breads = document.createElement('div');
    breads.className = 'header-breads';
    for (let i = 0; i < 3; ++i) {
      let img = document.createElement('img');
      img.src = i < gameState.collectedBreads ? gameState.breadImg.src : gameState.heartOutlineImg.src;
      img.alt = i < gameState.collectedBreads ? "Bread" : "Bread";
      breads.appendChild(img);
    }
    header.appendChild(breads);
    let fsbtn = document.createElement('button');
    fsbtn.className = 'fullscreen-btn';
    fsbtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M2 2v8h2V4h6V2H2zm14 0v2h6v6h2V2h-8zm6 14h-2v6h-6v2h8v-8zm-14 6v-2H4v-6H2v8h8z"/></svg>`;
    fsbtn.onclick = toggleFullscreen;
    header.appendChild(fsbtn);
    root.appendChild(header);
    let subbar = document.createElement('div');
    subbar.className = 'subtitle-bar';
    let subscroll = document.createElement('span');
    subscroll.className = 'subtitle-scroll';
    subscroll.innerText = gameState.subtitleCurrent || '';
    subscroll.style.transform = `translateX(${gameState.subtitleScrollX}px)`;
    subbar.appendChild(subscroll);
    root.appendChild(subbar);
    let cArea = document.createElement('div');
    cArea.className = 'game-canvas-area';
    let canvas = document.createElement('canvas');
    canvas.id = "game-canvas";
    canvas.width = 900;
    canvas.height = 500;
    cArea.appendChild(canvas);
    root.appendChild(cArea);
    let jumpCont = document.createElement('div');
    jumpCont.className = 'jump-btn-container';
    let jumpBtn = document.createElement('button');
    jumpBtn.className = 'jump-btn';
    jumpBtn.innerText = "JUMP";
    jumpBtn.onclick = playerJump;
    jumpBtn.id = "jump-btn";
    jumpCont.appendChild(jumpBtn);
    root.appendChild(jumpCont);
    setTimeout(() => document.getElementById("jump-btn").focus(), 300);
    setTimeout(() => {
      let bar = document.querySelector('.subtitle-bar');
      if (bar) gameState.subtitleBarWidth = bar.offsetWidth;
    }, 80);
    gameState.canvas = canvas;
    gameState.ctx = canvas.getContext('2d');
    if (!gameState.animFrame) {
      gameState.animFrame = requestAnimationFrame(gameLoop);
    }
  }

  // --- END/FAIL POPUP ---
  function renderEndPopup(root) {
    let overlay = document.createElement('div');
    overlay.className = 'popup-bg';
    let pop = document.createElement('div');
    pop.className = 'popup';
    let title = document.createElement('h2');
    if (gameState.endType === "win") title.innerText = "Level Complete!";
    else title.innerText = "Game Over!";
    pop.appendChild(title);
    let score = document.createElement('div');
    score.className = 'popup-score';
    for (let i = 0; i < 3; ++i) {
      let img = document.createElement('img');
      img.src = i < gameState.collectedBreads ? gameState.breadImg.src : gameState.heartOutlineImg.src;
      img.alt = i < gameState.collectedBreads ? "Bread" : "Bread";
      score.appendChild(img);
    }
    let sep = document.createElement('span');
    sep.style.margin = "0 10px";
    sep.innerText = "|";
    score.appendChild(sep);
    for (let i = 0; i < 3; ++i) {
      let img = document.createElement('img');
      img.src = i < gameState.lives ? gameState.heartImg.src : gameState.heartOutlineImg.src;
      img.alt = "Heart";
      img.style.marginLeft = "3px";
      score.appendChild(img);
    }
    pop.appendChild(score);
    let btns = document.createElement('div');
    btns.className = 'popup-btns';
    if (gameState.endType === "win" && gameState.selectedLevel < ASSETS.levels.length - 1) {
      let btnNext = document.createElement('button');
      btnNext.innerText = "Next Level";
      btnNext.onclick = () => {
        gameState.selectedLevel++;
        renderLevelStartPopup();
      };
      btns.appendChild(btnNext);
    }
    let btnRetry = document.createElement('button');
    btnRetry.innerText = "Try Again";
    btnRetry.onclick = () => {
      startGame();
    };
    let btnMenu = document.createElement('button');
    btnMenu.innerText = "Main Menu";
    btnMenu.onclick = () => {
      gameState.screen = "menu";
      render();
    };
    btns.appendChild(btnRetry);
    btns.appendChild(btnMenu);
    pop.appendChild(btns);
    overlay.appendChild(pop);
    root.appendChild(overlay);
  }

  // --------- GAME CORE LOGIC ---------
  function startGame() {
    stopMusic();
    gameState.lives = 3;
    gameState.collectedBreads = 0;
    gameState.running = false;
    gameState.jumpPressed = false;
    gameState.jumpStart = false;
    gameState.jumpY = 0;
    gameState.jumpV = 0;
    gameState.playerState = "idle";
    gameState.obstacleList = [];
    gameState.breadList = [];
    gameState.levelEnded = false;
    gameState.endType = null;
    if (!gameState.bgMusic) {
      gameState.bgMusic = new Audio(ASSETS.music);
      gameState.bgMusic.loop = true;
      gameState.bgMusic.volume = gameState.musicVolume;
    }
    gameState.bgMusic.currentTime = 0;
    gameState.bgMusic.play();
    if (gameState.levelAudio) { gameState.levelAudio.pause(); }
    gameState.levelAudio = new Audio(ASSETS.levels[gameState.selectedLevel].audio);
    gameState.levelAudio.volume = 1.0;
    gameState.levelAudio.currentTime = 0;
    loadVTT(ASSETS.levels[gameState.selectedLevel].vtt, (subtitles, duration) => {
      gameState.subtitles = subtitles;
      gameState.levelDuration = duration;
      gameState.subtitleIndex = 0;
      gameState.subtitleCurrent = '';
      gameState.subtitleScrollX = gameState.subtitleBarWidth || 400;
      gameState.subtitleActive = false;
      gameState.breadList = [
        { x: 600, collected: false },
        { x: 1200, collected: false },
        { x: 1800, collected: false }
      ];
      gameState.obstacleList = [];
      let obsPos = [400, 950, 1300, 1700];
      for (let x of obsPos) {
        gameState.obstacleList.push({ x, hit: false });
      }
      gameState.gameStartTime = null;
      gameState.audioStartedAt = null;
      gameState.screen = "game";
      render();
    });
  }

  // Load VTT and parse
  function loadVTT(vttUrl, cb) {
    fetch(vttUrl)
      .then(res => res.text())
      .then(txt => {
        let cues = [];
        let lines = txt.split('\n');
        let i = 0;
        let duration = 0;
        while (i < lines.length) {
          if (/^\d+$/.test(lines[i])) i++;
          if (i >= lines.length) break;
          let m = lines[i].match(/^(\d{2}:\d{2}:\d{2}\.\d{3}) --> (\d{2}:\d{2}:\d{2}\.\d{3})/);
          if (m) {
            let start = timeToSec(m[1]);
            let end = timeToSec(m[2]);
            let text = "";
            i++;
            while (i < lines.length && lines[i].trim() && !/^\d{2}:\d{2}:\d{2}\.\d{3}/.test(lines[i])) {
              text += lines[i] + " ";
              i++;
            }
            cues.push({ start, end, text: text.trim() });
            if (end > duration) duration = end;
          } else i++;
        }
        cb(cues, duration);
      });
  }
  function timeToSec(t) {
    let [h, m, s] = t.split(':');
    s = parseFloat(s);
    return (+h) * 3600 + (+m) * 60 + s;
  }

  // --- GAME CANVAS LOOP ---
  function gameLoop(ts) {
    if (gameState.screen !== "game" || !gameState.ctx) { gameState.animFrame = null; return; }
    let ctx = gameState.ctx, c = gameState.canvas;
    if (!gameState.gameStartTime) {
      gameState.gameStartTime = ts;
      gameState.lastFrameTime = ts;
    }
    let elapsed = (ts - gameState.gameStartTime)/1000;
    if (!gameState.running) {
      drawGameFrame(ctx, c.width, c.height, 0, true);
      gameState.animFrame = requestAnimationFrame(gameLoop);
      return;
    }
    let t = (performance.now() - gameState.audioStartedAt) / 1000;
    if (gameState.jumpStart) {
      if (gameState.jumpPressed) {
        gameState.jumpV = -5.5;
        gameState.jumpPressed = false;
      }
      gameState.jumpY += gameState.jumpV;
      gameState.jumpV += 0.33;
      if (gameState.jumpY > 0) {
        gameState.jumpY = 0;
        gameState.jumpV = 0;
        gameState.playerState = "idle";
      } else {
        gameState.playerState = "jump";
      }
    }
    let scrollSpeed = 4.2;
    let offset = t * scrollSpeed * 60;
    for (let obs of gameState.obstacleList) {
      let ox = obs.x - offset;
      if (!obs.hit && ox < 110 && ox > 40) {
        if (gameState.jumpY >= -10) {
          obs.hit = true;
          gameState.lives--;
          if (gameState.lives <= 0) {
            gameState.levelAudio.pause();
            gameState.levelEnded = true;
            gameState.endType = "fail";
            setTimeout(() => {
              updateScores();
              gameState.screen = "end";
              render();
            }, 500);
          }
        }
      }
    }
    for (let i = 0; i < gameState.breadList.length; ++i) {
      let bread = gameState.breadList[i];
      let bx = bread.x - offset;
      if (!bread.collected && bx < 120 && bx > 45) {
        if (gameState.jumpY >= -90) {
          bread.collected = true;
          gameState.collectedBreads++;
        }
      }
    }
    drawGameFrame(ctx, c.width, c.height, offset, false);
    let cue = null;
    for (let k = 0; k < gameState.subtitles.length; ++k) {
      if (t >= gameState.subtitles[k].start && t <= gameState.subtitles[k].end) {
        cue = gameState.subtitles[k];
        break;
      }
    }
    if (cue) {
      if (gameState.subtitleCurrent !== cue.text) {
        gameState.subtitleCurrent = cue.text;
        let bar = document.querySelector('.subtitle-bar');
        let s = document.querySelector('.subtitle-scroll');
        if (bar && s) {
          s.innerText = cue.text;
          let textW = s.offsetWidth;
          gameState.subtitleScrollX = bar.offsetWidth;
          let dur = cue.end - cue.start;
          let scroll = () => {
            if (gameState.screen !== "game" || gameState.subtitleCurrent !== cue.text) return;
            let tNow = (performance.now() - gameState.audioStartedAt)/1000;
            let prog = (tNow - cue.start) / dur;
            let barW = bar.offsetWidth;
            let minX = -textW;
            gameState.subtitleScrollX = barW - prog * (barW + textW);
            s.style.transform = `translateX(${gameState.subtitleScrollX}px)`;
            if (prog < 1) requestAnimationFrame(scroll);
          };
          requestAnimationFrame(scroll);
        }
      }
    }
    if (!gameState.levelEnded && t >= gameState.levelDuration) {
      gameState.levelEnded = true;
      gameState.endType = "win";
      setTimeout(() => {
        updateScores();
        gameState.screen = "end";
        render();
      }, 600);
    }
    gameState.animFrame = requestAnimationFrame(gameLoop);
  }

  // --- DRAW GAME FRAME ---
  function drawGameFrame(ctx, W, H, offset, idle) {
    ctx.clearRect(0,0,W,H);
    // Draw sky
    ctx.fillStyle = "#87b8e0";
    ctx.fillRect(0,0,W,H);
    // Draw ancient Jerusalem background (use silhouette image or simple shapes)
    let bg = gameState.bgImage;
    if (bg) {
      ctx.drawImage(bg, 0, 0, W, H-80);
    } else {
      // fallback: draw city walls, domes, palms, hills
      ctx.fillStyle = "#b8a078";
      ctx.beginPath();
      ctx.moveTo(0, H-230);
      ctx.lineTo(80, H-260);
      ctx.lineTo(160, H-215);
      ctx.lineTo(300, H-240);
      ctx.lineTo(400, H-195);
      ctx.lineTo(600, H-230);
      ctx.lineTo(720, H-210);
      ctx.lineTo(W, H-250);
      ctx.lineTo(W,0); ctx.lineTo(0,0);
      ctx.closePath();
      ctx.fill();
      ctx.fillStyle = "#cbb994";
      ctx.fillRect(100, H-260, 50, 60); // tower
      ctx.fillRect(200, H-240, 120, 50); // wall
      ctx.beginPath();
      ctx.arc(270, H-240, 25, 0, Math.PI, true); // dome
      ctx.fill();
    }
    // Draw hills
    ctx.fillStyle = "#e2c28b";
    ctx.beginPath();
    ctx.moveTo(0, H-95);
    ctx.bezierCurveTo(W/6, H-140, W/2, H-60, W, H-120);
    ctx.lineTo(W, H); ctx.lineTo(0,H); ctx.closePath();
    ctx.fill();
    // Draw stone path
    ctx.fillStyle = "#b8a078";
    ctx.fillRect(W/4, H-70, W/2, 36);
    // Draw sandy ground
    ctx.fillStyle = "#e2c28b";
    ctx.fillRect(0, H-70, W, 70);
    // Obstacles
    let obsImg = gameState.obstacleImg;
    for (let obs of gameState.obstacleList) {
      let ox = obs.x - offset;
      if (ox > -60 && ox < W+60) {
        ctx.globalAlpha = obs.hit ? 0.45 : 1.0;
        ctx.drawImage(obsImg, ox, H-130, 70, 70);
        ctx.globalAlpha = 1;
      }
    }
    // Bread awards
    let breadImg = gameState.breadImg;
    for (let bread of gameState.breadList) {
      let bx = bread.x - offset;
      if (bx > -40 && bx < W+40 && !bread.collected) {
        ctx.drawImage(breadImg, bx, H-180, 44, 44);
      }
    }
    // Character
    let playerX = 90;
    let playerY = H-70-88 + (gameState.jumpY || 0);
    let charImg = (gameState.playerState==="jump") ? gameState.charJump : gameState.charIdle;
    ctx.drawImage(charImg, playerX, playerY, 65, 88);
  }

  // --- PLAYER JUMP HANDLER ---
  function playerJump() {
    if (gameState.levelEnded) return;
    if (!gameState.running) {
      gameState.running = true;
      gameState.jumpStart = true;
      gameState.jumpPressed = true;
      gameState.levelAudio.currentTime = 0;
      gameState.levelAudio.play();
      gameState.audioStartedAt = performance.now();
    } else if (gameState.jumpY === 0) {
      gameState.jumpPressed = true;
    }
  }
  document.addEventListener('keydown', (e) => {
    if (gameState.screen === "game" && (e.code === "Space" || e.key === " ")) {
      playerJump();
      e.preventDefault();
    }
  });

  // --- FULLSCREEN HANDLER ---
  function toggleFullscreen() {
    let el = document.documentElement;
    if (!document.fullscreenElement && el.requestFullscreen) el.requestFullscreen();
    else if (document.exitFullscreen) document.exitFullscreen();
  }

  // --- AUDIO HANDLING ---
  function stopMusic() {
    if (gameState.bgMusic) {
      gameState.bgMusic.pause();
      gameState.bgMusic.currentTime = 0;
    }
    if (gameState.levelAudio) {
      gameState.levelAudio.pause();
      gameState.levelAudio.currentTime = 0;
    }
  }

  // --- SCORE/PROGRESS MEMORY ---
  function updateScores() {
    let i = gameState.selectedLevel;
    gameState.playedLevels[i] = true;
    if (gameState.collectedBreads > (gameState.breadScores[i] || 0)) {
      gameState.breadScores[i] = gameState.collectedBreads;
    }
    saveScores();
  }

  // --- INITIAL SETUP ---
  preloadImages((imgs) => {
    gameState.bgImage = imgs.bg;
    gameState.charIdle = imgs.charIdle;
    gameState.charJump = imgs.charJump;
    gameState.breadImg = imgs.bread;
    gameState.heartImg = imgs.heart;
    gameState.heartOutlineImg = imgs.heartOutline;
    gameState.obstacleImg = imgs.obstacle;
    let [scores, played] = loadScores();
    gameState.breadScores = scores;
    gameState.playedLevels = played;
    render();
  });

  window.addEventListener('resize', () => {
    if (gameState.screen === "game" && gameState.canvas) {
      let bar = document.querySelector('.subtitle-bar');
      if (bar) gameState.subtitleBarWidth = bar.offsetWidth;
    }
  });
  document.addEventListener('contextmenu', (e) => {
    if (e.target.id === "game-canvas") e.preventDefault();
  });
  document.addEventListener('touchmove', function(e) {
    if (gameState.screen === "game") e.preventDefault();
  }, { passive: false });

  </script>
</body>
</html>